import express from 'express';import session from 'express-session';import cors from 'cors';import { api } from './api.js';// Export the Express app as a named export// This is required by vite3-plugin-expressexport const app = express();// Global error handlersprocess.on('uncaughtException', error => {  console.error('ğŸ’¥ Uncaught Exception:', error);  console.error(error.stack);  process.exit(1);});process.on('unhandledRejection', (reason, promise) => {  console.error('ğŸ’¥ Unhandled Rejection at:', promise);  console.error('Reason:', reason);  process.exit(1);});app.set('trust proxy', true);// Middleware - ORDER MATTERS!// 1. CORS must be firstapp.use(  cors({    origin:      process.env.NODE_ENV === 'production'        ? process.env.FRONTEND_URL || true // Allow all origins in production if FRONTEND_URL not set        : 'http://localhost:5173',    credentials: true,  }));// 2. JSON parsingapp.use(express.json());// 3. Session middleware MUST come before Remult APIapp.use(  session({    secret: process.env.SESSION_SECRET || 'your-secret-key-change-in-production',    resave: false,    saveUninitialized: true, // Changed to true to ensure session object exists    cookie: {      httpOnly: true,      secure: process.env.NODE_ENV === 'production',      maxAge: 1000 * 60 * 60 * 24 * 7, // 7 days    },    name: 'mail-builder-server-session', // Custom session name  }));// 4. Health check endpoint (for Railway and monitoring)app.get('/health', async (_, res) => {  try {    // Always return healthy if server is running    const healthData = {      status: 'healthy',      timestamp: new Date().toISOString(),      uptime: process.uptime(),      environment: process.env.NODE_ENV || 'development',      port: process.env.PORT || 3002,      version: '1.0.0',      service: 'mail-builder-server',    };    res.status(200).json(healthData);  } catch (error) {    res.status(503).json({      status: 'unhealthy',      timestamp: new Date().toISOString(),      error: error instanceof Error ? error.message : 'Unknown error',    });  }});// 5. Remult API - this will now have access to req.sessionapp.use(api);// Only start the server when not running in Vite dev modeif (!process.env['VITE']) {  const port = parseInt(process.env['PORT'] || '3002', 10);  // Serve static files from dist  app.use(express.static('dist'));  // SPA fallback - serve index.html for non-API routes  // Note: Using app.use instead of app.get('*') for Express 5 compatibility  app.use((req, res, next) => {    if (!req.path.startsWith('/api') && !req.path.includes('.')) {      res.sendFile('dist/index.html', { root: process.cwd() });    } else {      next();    }  });  app.listen(port, '0.0.0.0', () => {    console.log('='.repeat(50));    console.log('ğŸš€ Server started successfully!');    console.log(`ğŸ“¡ Port: ${port}`);    console.log(`ğŸŒ Environment: ${process.env.NODE_ENV || 'development'}`);    console.log(`ğŸ¥ Health check: http://localhost:${port}/health`);    console.log(`ğŸ”— API endpoint: http://localhost:${port}/api`);    console.log('='.repeat(50));  });}